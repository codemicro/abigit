{{ import "fmt" }}
{{ import "path/filepath" }}
{{ import "github.com/codemicro/abigit/abigit/core" }}
{{ import "github.com/codemicro/abigit/abigit/urls" }}

{{ code }}
type ViewRepositoryProps struct {
    Repo *core.RepoOnDisk
    IsEmpty bool
}
{{ endcode }}

{{ func ViewRepository(ctx *RenderContext, props *ViewRepositoryProps) }}

    {{ code }}
        ctx.pageTitle = props.Repo.Slug + " | " + ctx.platformName
    {{ endcode }}

    {[ PageBegin(ctx) ]}
    {[ Navbar(ctx) ]}

    <div class="container">
        <h1>{[ props.Repo.Slug ]}</h1>
        <p class="secondary">{[ props.Repo.Description ]}</p>
        <p>Size on disk: {[ formatFileSize(props.Repo.Size) ]}</p>

        <div id="tabs" class="tabs"
             hx-get="{[ urls.Make(urls.RepositoryTabs, props.Repo.Slug) ]}"
             hx-trigger="load"
             hx-target="#tabs"
             hx-swap="innerHTML"
        ></div>
    </div>

    {[ PageEnd(ctx) ]}

{{ endfunc }}

{{ code }}
    const (
        TabSelectorReadme = 1 << iota
        TabSelectorShowTree
        TabSelectorShowRefs
        TabSelectorClone
    )

    type RepositoryTabProps struct {
        Repo *core.RepoOnDisk
        ShowTabs int
        CurrentTab int

        Readme struct {
            Content string
        }

        Clone struct {
            SSHUser string
            SSHHost string
            SSHStoragePath string
        }
    }
{{ endcode }}

{{ func RepositoryTabs(ctx *RenderContext, props *RepositoryTabProps) }}

    {{ code }}
        selectedTab := props.CurrentTab

        if props.ShowTabs & selectedTab == 0 {
            for selectedTab & 0b1 == 0 {
                if selectedTab == 0 {
                    break
                }

                selectedTab = selectedTab >> 1
            }
        }
    {{ endcode }}

    <div class="tab-list">

        {{ if props.ShowTabs & TabSelectorReadme != 0 }}
            <a hx-get="{[ urls.Make(urls.RepositoryTabReadme, props.Repo.Slug) ]}"
                {{ if selectedTab == TabSelectorReadme }}
                     class="selected"
                {{ endif }}
            >README</a>
        {{ endif }}

        {{ if props.ShowTabs & TabSelectorShowTree != 0 }}
            <a hx-get="{[ urls.Make(urls.RepositoryTabTree, props.Repo.Slug) ]}"
                {{ if selectedTab == TabSelectorShowTree }}
                    class="selected"
                {{ endif }}
            >Tree</a>
        {{ endif }}

        {{ if props.ShowTabs & TabSelectorShowRefs != 0 }}
            <a hx-get="{[ urls.Make(urls.RepositoryTabRefs, props.Repo.Slug) ]}"
                {{ if selectedTab == TabSelectorShowRefs }}
                    class="selected"
                {{ endif }}
            >Refs</a>
        {{ endif }}

        {{ if props.ShowTabs & TabSelectorClone != 0 }}
            <a hx-get="{[ urls.Make(urls.RepositoryTabClone, props.Repo.Slug) ]}"
                {{ if selectedTab == TabSelectorClone }}
                    class="selected"
                {{ endif }}
            >Clone</a>
        {{ endif }}

    </div>

    <div class="tab-content">
        {{ if selectedTab == TabSelectorReadme }}
            {[ repositoryTabReadme(ctx, props) ]}
        {{ elif selectedTab == TabSelectorShowTree }}
            {[ repositoryTabTree(ctx, props) ]}
        {{ elif selectedTab == TabSelectorShowRefs }}
            {[ repositoryTabRefs(ctx, props) ]}
        {{ elif selectedTab == TabSelectorClone }}
            {[ repositoryTabClone(ctx, props) ]}
        {{ endif }}
    </div>

{{ endfunc }}

{{ func repositoryTabReadme(ctx *RenderContext, props *RepositoryTabProps) }}
    <div class="readme-content">{[ props.Readme.Content #unsafe ]}</div>
{{ endfunc }}

{{ func repositoryTabTree(ctx *RenderContext, props *RepositoryTabProps) }}
    <p>TODO: tree here</p>
{{ endfunc }}

{{ func repositoryTabRefs(ctx *RenderContext, props *RepositoryTabProps) }}
    <p>TODO: refs here</p>
{{ endfunc }}

{{ func repositoryTabClone(ctx *RenderContext, props *RepositoryTabProps) }}
    <p>Clone with:</p>
    <ul>
        <li>SSH (read/write): {[ fmt.Sprintf("%s@%s:%s", props.Clone.SSHUser, props.Clone.SSHHost, filepath.Join(props.Clone.SSHStoragePath, props.Repo.Slug)) ]}</li>
        <li>HTTP (read-only): {[ urls.Make(urls.ServeRepositoryByName, props.Repo.Slug + ".git") ]}</li>
    </ul>

    <p>// TODO: Remember about securing private repositories.</p>
{{ endfunc }}